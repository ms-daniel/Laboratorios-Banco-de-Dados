CREATE DATABASE PROJETO_SAD

USE PROJETO_SAD

--ATENÇÃO!
--TODAS AS INFORMAÇÕES AQUI CONTIDAS SÃO FICTÍCIAS,
--OU SEJA, NÃO SÃO DADOS REAIS

CREATE TABLE TB_STATUS(
	ID_STATUS INT PRIMARY KEY NOT NULL,
	STATUS VARCHAR(30) CHECK (STATUS = 'Em Aberto' OR STATUS= 'Resolvido') NOT NULL
)

CREATE TABLE TB_CATEGORIA(
	ID_CATEGORIA INT PRIMARY KEY NOT NULL,
	CATEGORIA VARCHAR(30) NOT NULL
)

CREATE TABLE TB_ENDERECO(
	ID_ENDERECO INT PRIMARY KEY NOT NULL,
	UF VARCHAR(2) NOT NULL,
	CIDADE VARCHAR(30) NOT NULL,
	CEP VARCHAR(9) NOT NULL,
	BAIRRO VARCHAR(30),
	RUA VARCHAR(30) NOT NULL,
	NUMERO INT
)

CREATE TABLE TB_CAMPUS(
	ID_CAMPUS INT PRIMARY KEY NOT NULL,
	CNPJ VARCHAR(20) NOT NULL,
	NOME VARCHAR(60) NOT NULL,
	TELEFONE VARCHAR(20) NOT NULL,
	ID_ENDERECO INT NOT NULL,
	ID_DIRETOR INT NOT NULL
)

CREATE TABLE TB_FUNCIONARIO(
	ID_FUNCIONARIO INT PRIMARY KEY NOT NULL,
	MATRICULA varchar(20) NOT NULL,
	NOME VARCHAR(80) NOT NULL,
	EMAIL VARCHAR(50),
	TELEFONE VARCHAR(20),
	DATA_INICIO_CONTRATO DATETIME DEFAULT GETDATE() NOT NULL ,
	DATA_FIM_CONTRATO DATETIME,
	ID_DEPARTAMENTO INT,
	ID_ORGAO_RESPONSAVEL INT
)

CREATE TABLE TB_DEPARTAMENTO(
	ID_DEPARTAMENTO INT PRIMARY KEY NOT NULL,
	COD_DEPARTAMENTO INT NOT NULL,
	NOME VARCHAR(40) NOT NULL,
	SIGLA VARCHAR(6) NOT NULL,
	DESCRICAO VARCHAR(45),
	ID_DIRETOR INT NOT NULL,
	ID_CAMPUS INT NOT NULL
)

CREATE TABLE TB_ORGAO_RESPONSAVEL(
	ID_ORGAO_RESPONSAVEL INT PRIMARY KEY NOT NULL,
	COD_ORGAO_RESPONSAVEL INT NOT NULL,
	NOME VARCHAR(45) NOT NULL,
	SIGLA VARCHAR(6) NOT NULL,
	ID_COORDENADOR INT NOT NULL,
	ID_CAMPUS INT NOT NULL
)

CREATE TABLE TB_CHAMADO(
	ID_CHAMADO INT PRIMARY KEY NOT NULL,
	TITULO VARCHAR(45) NOT NULL,
	DESCRICAO VARCHAR(200) NOT NULL,
	LOCAL VARCHAR(60) NOT NULL,
	PRIORIDADE VARCHAR(45) CHECK (PRIORIDADE IN ('BAIXA', 'MEDIA', 'ALTA')) NOT NULL,
	MOTIVO VARCHAR(100),
	DATA_ABERTURA DATETIME DEFAULT GETDATE() NOT NULL,
	DATA_FECHAMENTO DATETIME,
	ID_REQUISITOR INT NOT NULL,
	ID_RESOLUTOR INT,
	ID_ORGAO_RESPONSAVEL INT NOT NULL,
	ID_STATUS INT NOT NULL,
	ID_CATEGORIA INT NOT NULL
)

--=============================================================================================================================================--

--INSERÇÃO NAS TABELAS SEM FOREIGN KEY
INSERT INTO TB_STATUS (ID_STATUS, STATUS) VALUES 
												(1, 'Em Aberto'),
												(2, 'Resolvido')

INSERT INTO TB_CATEGORIA (ID_CATEGORIA, CATEGORIA) VALUES
														(1, 'Manutenção de Equipamento'),
														(2, 'Instalação de Equipamento'),
														(3, 'Problemas com Equipamento'),
														(4, 'Problemas com Software'),
														(5, 'Instalação de Software'),
														(6, 'Problemas na Rede')

INSERT INTO TB_ENDERECO (ID_ENDERECO, UF, CIDADE, CEP, BAIRRO, RUA, NUMERO) VALUES
																			(1, 'SE', 'São Cirstovão', '49100-000', 'Rosa Elze', 'Av. Marechal Rondon', null),
																			(2, 'SE', 'Itabaiana', '49506-036', 'Sítio Porto', 'Av. Vereador Olímpio Grande', null),
																			(3, 'SE', 'Lagarto', '49400-000', 'Centro', 'Av. Governador Marcelo Déda', 13)

--=============================================================================================================================================--

--INSERÇÃO NAS TABLEAS COM FOREIGN KEY
INSERT INTO TB_CAMPUS (ID_CAMPUS, CNPJ, NOME, TELEFONE, ID_ENDERECO, ID_DIRETOR) VALUES
																					(1, '67.787.686/0001-83', 'Cidade Univ. Prof. José Aloísio de Campos', '+55 79 3996-6699', 1, 1),
																					(2, '07.660.586/0001-60', 'Campus Prof. Alberto Carvalho', '+55 79 3822-8288', 2, 2)

INSERT INTO TB_DEPARTAMENTO (ID_DEPARTAMENTO, COD_DEPARTAMENTO, NOME, SIGLA, DESCRICAO, ID_DIRETOR, ID_CAMPUS) VALUES
																													--CAMPUS ALBERTO
																													(1, 1, 'DEPARTAMENTO DE EDUCAÇÃO', 'DEDI', ' ', 3, 2),
																													(2, 2, 'DDEPARTAMENTO DE SISTEMA DE INFORMAÇÃO', 'DSI', ' ', 4, 2),
																													--CAMPUS JOSE
																													(3, 1, 'DEPARTAMENTO DE COMPUTAÇÃO', 'DECOMP', ' ', 5, 1),
																													(4, 2, 'DEPARTAMENTO DE FÍSICA', 'DFI', ' ', 6, 1 )

INSERT INTO TB_ORGAO_RESPONSAVEL (ID_ORGAO_RESPONSAVEL, COD_ORGAO_RESPONSAVEL, NOME, SIGLA, ID_COORDENADOR, ID_CAMPUS) VALUES
																													(2, 1, 'Centro de Processamento de Dados', 'CPD', 7, 2),
																													(1, 1, 'Superintendência de Tecnologia da Informação', 'STI', 8, 1)

INSERT INTO TB_FUNCIONARIO (ID_FUNCIONARIO, MATRICULA, NOME, TELEFONE, EMAIL, DATA_INICIO_CONTRATO, DATA_FIM_CONTRATO, ID_DEPARTAMENTO, ID_ORGAO_RESPONSAVEL) VALUES
																					(1, '200600000001', 'Jovinianour Valter de Santana Son', '11111111111111', 'diretor.sc@uf.br',  '01/01/2006', null, null, null),
																					(2, '200600000002', 'Hugo Vitu Sarmen Vilturinior',      '22222222222222', 'diretor.ita@uf.br', '01/01/2006', null, null, null),
																					(3, '200600000003', 'Elsa de Arendelle', '333333333333', 'diretor.dedi@uf.br', '01/01/2006', null, 1, null),
																					(4, '200600000004', 'Bruce Wayne', '444444444444', 'diretor.dsi@uf.br',  '01/01/2006', null, 2, null),
																					(5, '200600000005', 'Clark Kent Kal-El', '555555555555', 'diretor.decomp@uf.br', '01/01/2006', null, 3, null),
																					(6, '200600000006', 'Diana Prince', '666666666666', 'diretor.dfi@uf.br', '01/01/2006', null, 4, null),
																					(7, '200600000007', 'Marcus Túlio de Araújo Machado', '777777777777', 'coordenador.cpd@uf.br', '01/01/2006', null, null, 2),
																					(8, '200600000008', 'Andrés Ignácio Martinez Menéndez', '888888888888', '', '01/01/2006', null, null, 1)

--=============================================================================================================================================--

--FOREIGN KEYS
ALTER TABLE TB_CAMPUS ADD FOREIGN KEY (ID_ENDERECO) REFERENCES TB_ENDERECO(ID_ENDERECO)
ALTER TABLE TB_CAMPUS ADD FOREIGN KEY (ID_DIRETOR) REFERENCES TB_FUNCIONARIO(ID_FUNCIONARIO)

ALTER TABLE TB_DEPARTAMENTO ADD FOREIGN KEY (ID_DIRETOR) REFERENCES TB_FUNCIONARIO(ID_FUNCIONARIO)
ALTER TABLE TB_DEPARTAMENTO ADD FOREIGN KEY (ID_CAMPUS) REFERENCES TB_CAMPUS(ID_CAMPUS)

ALTER TABLE TB_ORGAO_RESPONSAVEL ADD FOREIGN KEY (ID_COORDENADOR) REFERENCES TB_FUNCIONARIO(ID_FUNCIONARIO)
ALTER TABLE TB_ORGAO_RESPONSAVEL ADD FOREIGN KEY (ID_CAMPUS) REFERENCES TB_CAMPUS(ID_CAMPUS)

ALTER TABLE TB_FUNCIONARIO ADD FOREIGN KEY (ID_DEPARTAMENTO) REFERENCES TB_DEPARTAMENTO(ID_DEPARTAMENTO)
ALTER TABLE TB_FUNCIONARIO ADD FOREIGN KEY (ID_ORGAO_RESPONSAVEL) REFERENCES TB_ORGAO_RESPONSAVEL(ID_ORGAO_RESPONSAVEL)

ALTER TABLE TB_CHAMADO ADD FOREIGN KEY (ID_REQUISITOR) REFERENCES TB_FUNCIONARIO(ID_FUNCIONARIO)
ALTER TABLE TB_CHAMADO ADD FOREIGN KEY (ID_RESOLUTOR) REFERENCES TB_FUNCIONARIO(ID_FUNCIONARIO)
ALTER TABLE TB_CHAMADO ADD FOREIGN KEY (ID_ORGAO_RESPONSAVEL) REFERENCES TB_ORGAO_RESPONSAVEL(ID_ORGAO_RESPONSAVEL)
ALTER TABLE TB_CHAMADO ADD FOREIGN KEY (ID_STATUS) REFERENCES TB_STATUS(ID_STATUS)
ALTER TABLE TB_CHAMADO ADD FOREIGN KEY (ID_CATEGORIA) REFERENCES TB_CATEGORIA(ID_CATEGORIA)

--=============================================================================================================================================--

SELECT * FROM TB_CAMPUS
SELECT * FROM TB_CATEGORIA
SELECT * FROM TB_DEPARTAMENTO
SELECT * FROM TB_ENDERECO
SELECT * FROM TB_FUNCIONARIO
SELECT * FROM TB_ORGAO_RESPONSAVEL
SELECT * FROM TB_STATUS

--=============================================================================================================================================--

--SELECT PARA CADA DEPARTAMENTO, SEUS DIRETORES, CAMPUS A QUAL PERTECEM, E DIRETORES/RETIORES DO CAMPUS
SELECT D.NOME,  F.NOME AS 'DIRETOR_DEPARTAMENTO', C.NOME, F2.NOME AS 'DIRETOR_CAMPUS'
FROM TB_DEPARTAMENTO D JOIN TB_CAMPUS C
ON (D.ID_CAMPUS = C.ID_CAMPUS)
JOIN TB_FUNCIONARIO F
ON (D.ID_DIRETOR = F.ID_FUNCIONARIO) 
JOIN TB_FUNCIONARIO F2
ON(C.ID_DIRETOR = F2.ID_FUNCIONARIO)

--=============================================================================================================================================--

use master
drop database PROJETO_SAD